<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periodic Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: "Times New Roman", "PMingLiU", "新細明體", serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1e3a8a;
        }
        
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animate-gradient {
            background: linear-gradient(to right, #1e3a8a, #3b82f6, #2563eb, #1e3a8a);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }

        @keyframes zoomIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-zoom-in {
            animation: zoomIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            backdrop-filter: blur(5px);
        }
        
        /* Mobile Scrollbar - apply custom scrollbar styles */
        .mobile-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .mobile-scroll::-webkit-scrollbar {
            width: 4px; /* Thinner for mobile */
        }
        .mobile-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .mobile-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* Gradient Mask for scrolling lists (Mobile) - Reduced Blur Range */
        .mask-image-gradient {
            mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black calc(100% - 20px), transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black calc(100% - 20px), transparent 100%);
        }

        /* Gradient Mask for Desktop - Reduced Blur Range */
        .mask-image-gradient-desktop {
            mask-image: linear-gradient(to bottom, transparent, black 30px, black calc(100% - 30px), transparent), 
                        linear-gradient(to right, transparent, black 30px, black calc(100% - 30px), transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 30px, black calc(100% - 30px), transparent), 
                                linear-gradient(to right, transparent, black 30px, black calc(100% - 30px), transparent);
            mask-composite: intersect;
            -webkit-mask-composite: source-in; /* For WebKit/Blink */
        }

        /* Info Content Styling */
        .element-info-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
        }
        .element-info-content li {
            margin-bottom: 0.5em;
        }
        /* Ensure bold text in markdown stands out */
        .element-info-content strong {
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        @media (max-width: 768px) {
            .element-info-content ul {
                padding-left: 1em;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, memo, forwardRef, useImperativeHandle } = React;
        const { createRoot } = ReactDOM;

        // --- constants.ts ---
        const ELEMENT_POSITIONS = [
            // Period 1
            { symbol: 'H', col: 1, row: 1 }, { symbol: 'He', col: 18, row: 1 },
            // Period 2
            { symbol: 'Li', col: 1, row: 2 }, { symbol: 'Be', col: 2, row: 2 },
            { symbol: 'B', col: 13, row: 2 }, { symbol: 'C', col: 14, row: 2 }, { symbol: 'N', col: 15, row: 2 }, { symbol: 'O', col: 16, row: 2 }, { symbol: 'F', col: 17, row: 2 }, { symbol: 'Ne', col: 18, row: 2 },
            // Period 3
            { symbol: 'Na', col: 1, row: 3 }, { symbol: 'Mg', col: 2, row: 3 },
            { symbol: 'Al', col: 13, row: 3 }, { symbol: 'Si', col: 14, row: 3 }, { symbol: 'P', col: 15, row: 3 }, { symbol: 'S', col: 16, row: 3 }, { symbol: 'Cl', col: 17, row: 3 }, { symbol: 'Ar', col: 18, row: 3 },
            // Period 4
            { symbol: 'K', col: 1, row: 4 }, { symbol: 'Ca', col: 2, row: 4 }, { symbol: 'Sc', col: 3, row: 4 }, { symbol: 'Ti', col: 4, row: 4 }, { symbol: 'V', col: 5, row: 4 }, { symbol: 'Cr', col: 6, row: 4 }, { symbol: 'Mn', col: 7, row: 4 }, { symbol: 'Fe', col: 8, row: 4 }, { symbol: 'Co', col: 9, row: 4 }, { symbol: 'Ni', col: 10, row: 4 }, { symbol: 'Cu', col: 11, row: 4 }, { symbol: 'Zn', col: 12, row: 4 }, { symbol: 'Ga', col: 13, row: 4 }, { symbol: 'Ge', col: 14, row: 4 }, { symbol: 'As', col: 15, row: 4 }, { symbol: 'Se', col: 16, row: 4 }, { symbol: 'Br', col: 17, row: 4 }, { symbol: 'Kr', col: 18, row: 4 },
            // Period 5
            { symbol: 'Rb', col: 1, row: 5 }, { symbol: 'Sr', col: 2, row: 5 }, { symbol: 'Y', col: 3, row: 5 }, { symbol: 'Zr', col: 4, row: 5 }, { symbol: 'Nb', col: 5, row: 5 }, { symbol: 'Mo', col: 6, row: 5 }, { symbol: 'Tc', col: 7, row: 5 }, { symbol: 'Ru', col: 8, row: 5 }, { symbol: 'Rh', col: 9, row: 5 }, { symbol: 'Pd', col: 10, row: 5 }, { symbol: 'Ag', col: 11, row: 5 }, { symbol: 'Cd', col: 12, row: 5 }, { symbol: 'In', col: 13, row: 5 }, { symbol: 'Sn', col: 14, row: 5 }, { symbol: 'Sb', col: 15, row: 5 }, { symbol: 'Te', col: 16, row: 5 }, { symbol: 'I', col: 17, row: 5 }, { symbol: 'Xe', col: 18, row: 5 },
            // Period 6
            { symbol: 'Cs', col: 1, row: 6 }, { symbol: 'Ba', col: 2, row: 6 }, 
            { symbol: '57-71', col: 3, row: 6 }, // Placeholder
            { symbol: 'Hf', col: 4, row: 6 }, { symbol: 'Ta', col: 5, row: 6 }, { symbol: 'W', col: 6, row: 6 }, { symbol: 'Re', col: 7, row: 6 }, { symbol: 'Os', col: 8, row: 6 }, { symbol: 'Ir', col: 9, row: 6 }, { symbol: 'Pt', col: 10, row: 6 }, { symbol: 'Au', col: 11, row: 6 }, { symbol: 'Hg', col: 12, row: 6 }, { symbol: 'Tl', col: 13, row: 6 }, { symbol: 'Pb', col: 14, row: 6 }, { symbol: 'Bi', col: 15, row: 6 }, { symbol: 'Po', col: 16, row: 6 }, { symbol: 'At', col: 17, row: 6 }, { symbol: 'Rn', col: 18, row: 6 },
            // Period 7
            { symbol: 'Fr', col: 1, row: 7 }, { symbol: 'Ra', col: 2, row: 7 },
            { symbol: '89-103', col: 3, row: 7 }, // Placeholder
            { symbol: 'Rf', col: 4, row: 7 }, { symbol: 'Db', col: 5, row: 7 }, { symbol: 'Sg', col: 6, row: 7 }, { symbol: 'Bh', col: 7, row: 7 }, { symbol: 'Hs', col: 8, row: 7 }, { symbol: 'Mt', col: 9, row: 7 }, { symbol: 'Ds', col: 10, row: 7 }, { symbol: 'Rg', col: 11, row: 7 }, { symbol: 'Cn', col: 12, row: 7 }, { symbol: 'Nh', col: 13, row: 7 }, { symbol: 'Fl', col: 14, row: 7 }, { symbol: 'Mc', col: 15, row: 7 }, { symbol: 'Lv', col: 16, row: 7 }, { symbol: 'Ts', col: 17, row: 7 }, { symbol: 'Og', col: 18, row: 7 },
            
            // Row 8 is now BLANK SPACE

            // Lanthanides (Shifted to Row 9)
            { symbol: 'La', col: 4, row: 9 }, { symbol: 'Ce', col: 5, row: 9 }, { symbol: 'Pr', col: 6, row: 9 }, { symbol: 'Nd', col: 7, row: 9 }, { symbol: 'Pm', col: 8, row: 9 }, { symbol: 'Sm', col: 9, row: 9 }, { symbol: 'Eu', col: 10, row: 9 }, { symbol: 'Gd', col: 11, row: 9 }, { symbol: 'Tb', col: 12, row: 9 }, { symbol: 'Dy', col: 13, row: 9 }, { symbol: 'Ho', col: 14, row: 9 }, { symbol: 'Er', col: 15, row: 9 }, { symbol: 'Tm', col: 16, row: 9 }, { symbol: 'Yb', col: 17, row: 9 }, { symbol: 'Lu', col: 18, row: 9 },
            // Actinides (Shifted to Row 10)
            { symbol: 'Ac', col: 4, row: 10 }, { symbol: 'Th', col: 5, row: 10 }, { symbol: 'Pa', col: 6, row: 10 }, { symbol: 'U', col: 7, row: 10 }, { symbol: 'Np', col: 8, row: 10 }, { symbol: 'Pu', col: 9, row: 10 }, { symbol: 'Am', col: 10, row: 10 }, { symbol: 'Cm', col: 11, row: 10 }, { symbol: 'Bk', col: 12, row: 10 }, { symbol: 'Cf', col: 13, row: 10 }, { symbol: 'Es', col: 14, row: 10 }, { symbol: 'Fm', col: 15, row: 10 }, { symbol: 'Md', col: 16, row: 10 }, { symbol: 'No', col: 17, row: 10 }, { symbol: 'Lr', col: 18, row: 10 },
        ];

        const RAW_DATA = [
            [1, "H", "氫", "1"], [2, "He", "氦", "4"],
            [3, "Li", "鋰", "7"], [4, "Be", "鈹", "9"],
            [5, "B", "硼", "11"], [6, "C", "碳", "12"], [7, "N", "氮", "14"], [8, "O", "氧", "16"], [9, "F", "氟", "19"], [10, "Ne", "氖", "20"],
            [11, "Na", "鈉", "23"], [12, "Mg", "鎂", "24"],
            [13, "Al", "鋁", "27"], [14, "Si", "矽", "28"], [15, "P", "磷", "31"], [16, "S", "硫", "32"], [17, "Cl", "氯", "35.5"], [18, "Ar", "氬", "40"],
            [19, "K", "鉀", "39"], [20, "Ca", "鈣", "40"], [21, "Sc", "鈧", "45"], [22, "Ti", "鈦", "48"], [23, "V", "釩", "51"], [24, "Cr", "鉻", "52"], [25, "Mn", "錳", "55"], [26, "Fe", "鐵", "56"], [27, "Co", "鈷", "59"], [28, "Ni", "鎳", "59"], [29, "Cu", "銅", "63.5"], [30, "Zn", "鋅", "65"], [31, "Ga", "鎵", "70"], [32, "Ge", "鍺", "73"], [33, "As", "砷", "75"], [34, "Se", "硒", "79"], [35, "Br", "溴", "80"], [36, "Kr", "氪", "84"],
            [37, "Rb", "銣", "85.5"], [38, "Sr", "鍶", "88"], [39, "Y", "釔", "89"], [40, "Zr", "鋯", "91"], [41, "Nb", "鈮", "93"], [42, "Mo", "鉬", "96"], [43, "Tc", "鎝", "(98)"], [44, "Ru", "釕", "101"], [45, "Rh", "銠", "103"], [46, "Pd", "鈀", "106"], [47, "Ag", "銀", "108"], [48, "Cd", "鎘", "112"], [49, "In", "銦", "115"], [50, "Sn", "錫", "119"], [51, "Sb", "銻", "122"], [52, "Te", "碲", "128"], [53, "I", "碘", "127"], [54, "Xe", "氙", "131"],
            [55, "Cs", "銫", "133"], [56, "Ba", "鋇", "137"],
            [0, "57-71", "", ""], // Placeholder Data
            [57, "La", "鑭", "139"], [58, "Ce", "鈰", "140"], [59, "Pr", "鐠", "141"], [60, "Nd", "釹", "144"], [61, "Pm", "鉕", "(145)"], [62, "Sm", "釤", "150"], [63, "Eu", "銪", "152"], [64, "Gd", "釓", "157"], [65, "Tb", "鋱", "159"], [66, "Dy", "鏑", "162.5"], [67, "Ho", "鈥", "165"], [68, "Er", "鉺", "167"], [69, "Tm", "銩", "169"], [70, "Yb", "鐿", "173"], [71, "Lu", "鎦", "175"],
            [72, "Hf", "鉿", "178"], [73, "Ta", "鉭", "181"], [74, "W", "鎢", "184"], [75, "Re", "錸", "186"], [76, "Os", "鋨", "190"], [77, "Ir", "銥", "192"], [78, "Pt", "鉑", "195"], [79, "Au", "金", "197"], [80, "Hg", "汞", "201"], [81, "Tl", "鉈", "204"], [82, "Pb", "鉛", "207"], [83, "Bi", "鉍", "209"], [84, "Po", "釙", "(209)"], [85, "At", "砈", "(210)"], [86, "Rn", "氡", "(222)"],
            [87, "Fr", "鍅", "(223)"], [88, "Ra", "鐳", "(226)"],
            [0, "89-103", "", ""], // Placeholder Data
            [89, "Ac", "錒", "(227)"], [90, "Th", "釷", "232"], [91, "Pa", "鏷", "231"], [92, "U", "鈾", "238"], [93, "Np", "錼", "(237)"], [94, "Pu", "鈽", "(244)"], [95, "Am", "鋂", "(243)"], [96, "Cm", "鋦", "(247)"], [97, "Bk", "鉳", "(247)"], [98, "Cf", "鉲", "(251)"], [99, "Es", "鑀", "(252)"], [100, "Fm", "鐨", "(257)"], [101, "Md", "鍆", "(258)"], [102, "No", "鍩", "(259)"], [103, "Lr", "鐒", "(266)"],
            [104, "Rf", "鑪", "(267)"], [105, "Db", "𨧀", "(268)"], [106, "Sg", "𨭎", "(269)"], [107, "Bh", "𨨏", "(270)"], [108, "Hs", "𨭆", "(277)"], [109, "Mt", "䥑", "(278)"], [110, "Ds", "鐽", "(281)"], [111, "Rg", "錀", "(282)"], [112, "Cn", "鎶", "(285)"], [113, "Nh", "鉨", "(286)"], [114, "Fl", "鈇", "(289)"], [115, "Mc", "鏌", "(290)"], [116, "Lv", "鉝", "(293)"], [117, "Ts", "鿬", "(294)"], [118, "Og", "鿫", "(294)"]
        ];

        const ELEMENT_DATA = {};
        RAW_DATA.forEach(([num, sym, name, mass]) => {
            ELEMENT_DATA[sym] = {
                atomicNumber: num,
                symbol: sym,
                name: name,
                atomicMass: mass,
                info: `<ul><li>原子序: ${num}</li><li>元素名稱: ${name}</li><li>原子量: ${mass}</li></ul>`
            };
        });

        // --- utils.ts ---
        const parseMarkdownData = (text) => {
            const elements = {};
            // Normalize line endings
            text = text.replace(/\r\n/g, '\n');

            // Split by '### **序:' which denotes a new element block
            const blocks = text.split(/^### \*\*序:/m).slice(1);

            blocks.forEach(block => {
                try {
                    const firstLineEnd = block.indexOf('\n');
                    const firstLine = block.substring(0, firstLineEnd > -1 ? firstLineEnd : block.length);
                    const numberMatch = firstLine.match(/^\s*(\d+)/);
                    const atomicNumber = numberMatch ? parseInt(numberMatch[1]) : 0;

                    const nameMatch = block.match(/^- \*\*中文:\*\*\s*(.+)$/m);
                    const name = nameMatch ? nameMatch[1].trim() : '';

                    const symbolMatch = block.match(/^- \*\*符號:\*\*\s*(.+)$/m);
                    const symbol = symbolMatch ? symbolMatch[1].trim() : '';

                    const massMatch = block.match(/^- \*\*原子量:\*\*\s*(.+)$/m);
                    const atomicMass = massMatch ? massMatch[1].trim() : '';

                    const descriptionHeaderRegex = /^- \*\*敘述:\*\*\s*$/m;
                    const descMatch = block.match(descriptionHeaderRegex);
                    
                    let infoHtml = '';
                    
                    if (descMatch && descMatch.index !== undefined) {
                        const startIndex = descMatch.index + descMatch[0].length;
                        const rawInfo = block.substring(startIndex).trim();
                        
                        const lines = rawInfo.split('\n');
                        let listItems = '';
                        
                        lines.forEach(line => {
                            const trimmed = line.trim();
                            if (trimmed.startsWith('-')) {
                                const content = trimmed.replace(/^-\s*/, '').trim();
                                if (content) {
                                    listItems += `<li>${content}</li>`;
                                }
                            }
                        });
                        
                        if (listItems) {
                            infoHtml = `<ul>${listItems}</ul>`;
                        }
                    }

                    if (symbol && atomicNumber) {
                        const entry = {
                            atomicNumber,
                            symbol,
                            name,
                            atomicMass
                        };
                        if (infoHtml) {
                            entry.info = infoHtml;
                        }
                        elements[symbol] = entry;
                    }
                } catch (e) {
                    console.warn('Error parsing block for element', e);
                }
            });

            return elements;
        };

        // --- components/ElementCard.tsx ---
        // Optimization: Wrapped in React.memo to prevent re-renders when parent transforms change
        const ElementCard = memo(({ element, isDimmed, onPlaceholderClick, isExpanded }) => {
            // Check for placeholders
            const isPlaceholder = element.symbol.includes('-');
            
            // Format atomic mass
            let displayMass = '';
            if (element.atomicMass && !isPlaceholder) {
                let cleanMass = element.atomicMass.toString();
                const massVal = parseFloat(cleanMass.replace(/[()]/g, ''));
                if (!isNaN(massVal)) {
                    displayMass = Math.round(massVal).toString();
                } else {
                    const match = cleanMass.match(/\d+/);
                    displayMass = match ? match[0] : '?';
                }
            }

            // Render Placeholder (Lanthanides/Actinides toggle buttons)
            if (isPlaceholder) {
                const baseStyle = "rounded-[4px] border border-white/20 backdrop-blur-[4px] flex flex-col items-center justify-center text-white select-none font-serif cursor-pointer transition-all duration-200 shadow-sm relative";
                
                const stateStyle = isExpanded 
                    ? "bg-white/5 hover:bg-white/15 text-white/70"
                    : "bg-white/10 hover:bg-white/20 hover:scale-105 hover:shadow-[0_0_15px_rgba(255,255,255,0.3)]";

                return (
                    <div
                        onClick={(e) => {
                            e.stopPropagation();
                            onPlaceholderClick?.();
                        }}
                        className={`${baseStyle} ${stateStyle}`}
                        style={{
                            gridColumn: element.col,
                            gridRow: element.row,
                            width: '100%',
                            height: '100%',
                            transition: 'opacity 0.3s ease, filter 0.3s ease, transform 0.2s ease, background-color 0.2s ease',
                            opacity: isDimmed ? 0.2 : 1,
                            filter: isDimmed ? 'grayscale(100%) blur(1px)' : 'none',
                            transform: isExpanded ? undefined : (isDimmed ? 'scale(0.95)' : undefined),
                            pointerEvents: isDimmed ? 'none' : 'auto'
                        }}
                    >
                        <span className="text-[10px] md:text-xs font-medium tracking-widest">{element.symbol}</span>
                        {/* Plus Icon indicating expansion */}
                        <div className={`absolute bottom-1.5 right-1.5 transition-transform duration-300 ${isExpanded ? 'rotate-45' : 'rotate-0'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="opacity-60">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </div>
                    </div>
                );
            }

            return (
                <div
                    data-symbol={element.symbol}
                    className={`
                        relative
                        bg-white/10 backdrop-blur-[4px] 
                        rounded-[4px]
                        flex flex-col justify-between items-center
                        hover:z-10 hover:bg-white/20 hover:scale-110 hover:shadow-[0_0_15px_rgba(255,255,255,0.3)]
                        border border-white/20 text-white select-none
                        font-serif pointer-events-auto
                    `}
                    style={{
                        gridColumn: element.col,
                        gridRow: element.row,
                        transition: 'opacity 0.3s ease, filter 0.3s ease, transform 0.2s ease, background-color 0.2s ease',
                        opacity: isDimmed ? 0.2 : 1,
                        filter: isDimmed ? 'grayscale(100%) blur(1px)' : 'none',
                        transform: isDimmed ? 'scale(0.95)' : undefined,
                        width: '100%',
                        height: '100%',
                        padding: '2px 4px',
                    }}
                >
                    <div className="w-full flex justify-start items-start leading-none pt-0.5">
                        <span className="text-[10px] opacity-80 font-bold">
                            {element.atomicNumber}
                        </span>
                    </div>

                    <div className="flex-1 flex flex-col justify-center items-center -mt-2">
                        <span className="text-xl md:text-2xl font-bold leading-none tracking-wider text-shadow-sm mb-0">
                            {element.symbol}
                        </span>
                        <span className="text-[10px] md:text-xs font-medium opacity-80 leading-none">
                            {element.name}
                        </span>
                        <span className="text-[9px] md:text-[10px] font-medium opacity-60 leading-none mt-1">
                            {displayMass}
                        </span>
                    </div>
                </div>
            );
        });

        // --- components/DetailModal.tsx ---
        const DetailModal = ({ element, onClose }) => {
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onClose]);

            if (!element) return null;

            return (
                <div 
                    className="fixed inset-0 z-50 flex items-center justify-center bg-white/5 backdrop-blur-[15px] animate-zoom-in"
                    onClick={(e) => {
                        if (e.target === e.currentTarget) onClose();
                    }}
                >
                    <div className="relative w-full h-full max-w-[calc(100%-40px)] max-h-[calc(100%-40px)] m-auto bg-white/10 rounded-[20px] shadow-2xl backdrop-blur-xl flex flex-col overflow-hidden border border-white/20">
                        <div className="relative p-5 text-center shrink-0 z-10 bg-white/5 border-b border-white/10">
                            <button 
                                onClick={onClose}
                                className="absolute top-5 right-5 w-10 h-10 flex items-center justify-center bg-white/15 rounded-full text-white font-bold text-xl backdrop-blur-md shadow-lg transition-transform hover:scale-110 active:scale-95 border border-white/10 z-20"
                            >
                                ×
                            </button>
                            <h2 className="text-4xl text-white drop-shadow-md font-bold font-serif">
                                {element.atomicNumber} - {element.symbol} - {element.name}
                            </h2>
                        </div>
                        
                        <div 
                            className="flex-1 overflow-y-auto custom-scrollbar relative"
                            style={{
                                maskImage: 'linear-gradient(to bottom, transparent 0%, black 20px, black calc(100% - 20px), transparent 100%)',
                                WebkitMaskImage: 'linear-gradient(to bottom, transparent 0%, black 20px, black calc(100% - 20px), transparent 100%)'
                            }}
                        >
                            <div 
                                className="prose prose-invert prose-lg max-w-none text-white text-left drop-shadow-md font-serif px-4 py-4 md:px-8 md:py-8"
                                style={{ fontSize: '24px', lineHeight: '1.6' }}
                            >
                                <div className="element-info-content" dangerouslySetInnerHTML={{ __html: element.info }} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- components/ControlPanel.tsx ---
        const ControlPanel = ({ searchQuery, setSearchQuery, isMobile, onReset }) => {
            return (
                <div className={`
                    relative z-40 bg-white/10 rounded-full backdrop-blur-md shadow-lg border border-white/10 
                    flex items-center gap-2 mt-4 mb-2 p-1.5 px-3
                    ${isMobile ? 'w-[90%] mx-auto' : ''}
                `}>
                    <div className="flex items-center gap-2 w-full md:w-auto flex-1 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white/80 shrink-0">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <div className="relative w-full md:w-40">
                            <input 
                                type="text" 
                                id="searchInput"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="符號 / 名稱 / 序號"
                                className="w-full bg-transparent text-white text-sm placeholder-white/40 focus:outline-none font-serif pr-6"
                            />
                            {searchQuery && (
                                <button 
                                    onClick={() => setSearchQuery('')} 
                                    className="absolute right-0 top-1/2 -translate-y-1/2 text-white/50 hover:text-white"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="w-[1px] h-4 bg-white/20 mx-1 shrink-0"></div>

                    <button 
                        onClick={onReset}
                        className="p-1 rounded-full hover:bg-white/10 text-white/80 transition-colors shrink-0"
                        title="重置視圖"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </button>
                </div>
            );
        };

        // --- components/PeriodicTable.tsx ---
        const CELL_WIDTH = 64; 
        const CELL_HEIGHT = 80; 
        const GAP = 6; 
        const GRID_COLS = 18;
        const GAP_ROW_HEIGHT = 30; 

        const PeriodicTable = forwardRef(({ searchQuery, onElementClick, isMobile, elementDataOverride }, ref) => {
            const containerRef = useRef(null);
            const mobileContainerRef = useRef(null);
            
            const [transform, setTransform] = useState({ x: 0, y: 0, k: 1 });
            const [showSeries, setShowSeries] = useState(false);

            // Calculate table dimensions
            const GRID_ROWS = showSeries ? 10 : 7;
            const TABLE_WIDTH = GRID_COLS * CELL_WIDTH + (GRID_COLS - 1) * GAP;
            
            const heightRows1to7 = 7 * CELL_HEIGHT;
            const heightSeries = 2 * CELL_HEIGHT;
            const gapsStandard = (7 - 1) * GAP; 
            const gapBetween7and8 = GAP;
            const gapBetween8and9 = GAP;
            const gapBetween9and10 = GAP;
            
            let TABLE_HEIGHT = heightRows1to7 + gapsStandard;
            if (showSeries) {
                TABLE_HEIGHT += gapBetween7and8 + GAP_ROW_HEIGHT + gapBetween8and9 + heightSeries + gapBetween9and10;
            }

            const isDraggingRef = useRef(false);
            const startPosRef = useRef({ x: 0, y: 0 });
            const lastTransformRef = useRef({ x: 0, y: 0 });
            const hasMovedRef = useRef(false); 

            const centerTable = useCallback(() => {
                if (containerRef.current) {
                    const { clientWidth, clientHeight } = containerRef.current;
                    if (clientWidth === 0 || clientHeight === 0) return;

                    const padding = 40;
                    const availableWidth = clientWidth - padding;
                    const availableHeight = clientHeight - padding;

                    let scale = Math.min(availableWidth / TABLE_WIDTH, availableHeight / TABLE_HEIGHT);
                    if (scale > 1.2) scale = 1.2;
                    if (scale < 0.1) scale = 0.1;
                    
                    const centerX = (clientWidth - TABLE_WIDTH * scale) / 2;
                    const centerY = (clientHeight - TABLE_HEIGHT * scale) / 2;
                    
                    setTransform({ x: centerX, y: centerY, k: scale });
                }
            }, [TABLE_HEIGHT, TABLE_WIDTH]);

            useImperativeHandle(ref, () => ({
                resetView: () => {
                    centerTable();
                    setShowSeries(false);
                    if (mobileContainerRef.current) {
                        mobileContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            }));

            useEffect(() => {
                const timer = setTimeout(centerTable, 100);
                return () => clearTimeout(timer);
            }, [showSeries, centerTable]);

            useEffect(() => {
                const timer = setTimeout(centerTable, 100);
                window.addEventListener('resize', centerTable);
                return () => {
                    window.removeEventListener('resize', centerTable);
                    clearTimeout(timer);
                };
            }, [isMobile, centerTable]); 

            const handleWheel = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const ZOOM_SPEED = 0.001;
                const minScale = 0.35;
                const maxScale = 4;
                const delta = -e.deltaY * ZOOM_SPEED;
                let newScale = transform.k * (1 + delta);
                newScale = Math.min(Math.max(newScale, minScale), maxScale);
                const rect = containerRef.current.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const newX = mouseX - (mouseX - transform.x) * (newScale / transform.k);
                const newY = mouseY - (mouseY - transform.y) * (newScale / transform.k);
                setTransform({ x: newX, y: newY, k: newScale });
            };

            // Memoized to prevent creating new FullElements on every render unless data changes
            const fullElements = useMemo(() => {
                const dataDisplay = elementDataOverride || ELEMENT_DATA;
                return ELEMENT_POSITIONS.map((pos) => {
                    const data = dataDisplay[pos.symbol];
                    if(!data) {
                        return {
                            ...pos,
                            atomicNumber: 0,
                            symbol: pos.symbol,
                            name: '',
                            atomicMass: '',
                            info: ''
                        };
                    }
                    return { ...data, ...pos };
                });
            }, [elementDataOverride]);

            useEffect(() => {
                const handleWindowPointerMove = (e) => {
                    if (!isDraggingRef.current) return;
                    const dx = e.clientX - startPosRef.current.x;
                    const dy = e.clientY - startPosRef.current.y;
                    
                    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                        hasMovedRef.current = true;
                    }

                    setTransform({
                        x: lastTransformRef.current.x + dx,
                        y: lastTransformRef.current.y + dy,
                        k: transform.k 
                    });
                };

                const handleWindowPointerUp = (e) => {
                    if (!isDraggingRef.current) return;
                    isDraggingRef.current = false;
                    
                    if(containerRef.current) containerRef.current.style.cursor = 'grab';

                    if (!hasMovedRef.current) {
                        const target = document.elementFromPoint(e.clientX, e.clientY);
                        const card = target?.closest('[data-symbol]');
                        if (card) {
                            const symbol = card.getAttribute('data-symbol');
                            const element = fullElements.find(el => el.symbol === symbol);
                            if (element && !element.symbol.includes('-')) {
                                onElementClick(element);
                            }
                        }
                    }
                };

                window.addEventListener('pointermove', handleWindowPointerMove);
                window.addEventListener('pointerup', handleWindowPointerUp);
                
                return () => {
                    window.removeEventListener('pointermove', handleWindowPointerMove);
                    window.removeEventListener('pointerup', handleWindowPointerUp);
                }
            }, [transform.k, transform.x, transform.y, fullElements, onElementClick]); 
            
            const handlePointerDown = (e) => {
                isDraggingRef.current = true;
                hasMovedRef.current = false;
                startPosRef.current = { x: e.clientX, y: e.clientY };
                lastTransformRef.current = { x: transform.x, y: transform.y };
                if(containerRef.current) containerRef.current.style.cursor = 'grabbing';
            };

            const isMatch = useCallback((el) => {
                if (!searchQuery) return true;
                const q = searchQuery.toLowerCase();
                return (
                    el.symbol.toLowerCase().includes(q) ||
                    el.name.toLowerCase().includes(q) ||
                    el.atomicNumber.toString().includes(q)
                );
            }, [searchQuery]);

            useEffect(() => {
                if (!searchQuery) {
                    setShowSeries(false);
                    return;
                }
                
                const hiddenMatch = fullElements.some(el => {
                    if (el.row === 9 || el.row === 10) {
                        return isMatch(el);
                    }
                    return false;
                });

                setShowSeries(hiddenMatch);
                
            }, [searchQuery, fullElements, isMatch]);

            // Optimization: Stable handler for toggle
            const toggleSeries = useCallback(() => setShowSeries(prev => !prev), []);

            if (isMobile) {
                const filteredElements = fullElements
                    .filter(el => !el.symbol.includes('-') && isMatch(el))
                    .sort((a, b) => a.atomicNumber - b.atomicNumber);

                return (
                    <div 
                        ref={mobileContainerRef}
                        className="w-full h-full overflow-y-scroll px-4 pb-24 mobile-scroll pt-6 mask-image-gradient custom-scrollbar"
                    >
                        <div className="grid grid-cols-3 gap-3 w-full max-w-lg mx-auto">
                        {filteredElements.map((el) => (
                            <div key={el.symbol} 
                                className="relative aspect-[5/4]"
                                onClick={() => onElementClick(el)}
                            >
                                <ElementCard element={el} />
                            </div>
                        ))}
                        </div>
                        {filteredElements.length === 0 && (
                        <div className="text-white/70 text-center mt-10 font-serif">沒有找到匹配的元素</div>
                        )}
                    </div>
                );
            }

            const visibleElements = fullElements.filter(el => {
                if (!showSeries) {
                    if (el.row === 9 || el.row === 10) return false;
                }
                return true;
            });

            const gridRowsDef = showSeries 
                ? `repeat(7, ${CELL_HEIGHT}px) ${GAP_ROW_HEIGHT}px repeat(2, ${CELL_HEIGHT}px)`
                : `repeat(7, ${CELL_HEIGHT}px)`;

            return (
                <div
                    ref={containerRef}
                    className="relative w-full h-full overflow-hidden touch-none bg-transparent cursor-grab active:cursor-grabbing mask-image-gradient-desktop"
                    onWheel={handleWheel}
                    onPointerDown={handlePointerDown}
                >
                    <div
                        className="absolute origin-top-left will-change-transform transition-all duration-300 ease-out"
                        style={{
                            transform: `translate3d(${transform.x}px, ${transform.y}px, 0) scale(${transform.k})`,
                            width: `${TABLE_WIDTH}px`,
                            height: `${TABLE_HEIGHT}px`,
                        }}
                    >
                        <div 
                            className="grid w-full h-full"
                            style={{
                                gridTemplateColumns: `repeat(${GRID_COLS}, ${CELL_WIDTH}px)`,
                                gridTemplateRows: gridRowsDef,
                                gap: `${GAP}px`,
                                gridAutoRows: '0px', 
                            }}
                        >
                            {visibleElements.map((el) => {
                                const matched = isMatch(el);
                                return (
                                    <ElementCard
                                        key={el.symbol}
                                        element={el}
                                        isDimmed={searchQuery !== '' && !matched}
                                        onPlaceholderClick={toggleSeries}
                                        isExpanded={showSeries}
                                    />
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        });

        // --- App.tsx ---
        const App = () => {
            const [isMobile, setIsMobile] = useState(false);
            const [selectedElement, setSelectedElement] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [elementData, setElementData] = useState(ELEMENT_DATA);
            
            const tableRef = useRef(null);

            useEffect(() => {
                const handleResize = () => {
                    setIsMobile(window.innerWidth < 768);
                };
                handleResize();
                window.addEventListener('resize', handleResize);

                // Load Markdown Data
                fetch('element.md')
                    .then(response => {
                        if (!response.ok) throw new Error("Markdown file not found");
                        return response.text();
                    })
                    .then(text => {
                        const parsedData = parseMarkdownData(text);
                        setElementData(prev => {
                            const newData = { ...prev };
                            Object.keys(parsedData).forEach(key => {
                                newData[key] = {
                                    ...newData[key],
                                    ...parsedData[key]
                                };
                            });
                            return newData;
                        });
                    })
                    .catch(err => console.error("Failed to load element.md", err));

                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const handleReset = () => {
                setSearchQuery('');
                tableRef.current?.resetView();
            };

            return (
                <div className="relative w-screen h-screen overflow-hidden flex flex-col items-center animate-gradient text-white font-serif">
                    {/* Background overlay */}
                    <div className={`absolute inset-0 transition-opacity duration-300 pointer-events-none ${selectedElement ? 'bg-black/40 backdrop-blur-sm z-30' : 'opacity-0'}`} />

                    <ControlPanel 
                        searchQuery={searchQuery}
                        setSearchQuery={setSearchQuery}
                        isMobile={isMobile}
                        onReset={handleReset}
                    />
                    
                    <div className="flex-1 w-full relative overflow-hidden">
                        <PeriodicTable 
                            ref={tableRef}
                            searchQuery={searchQuery}
                            onElementClick={(el) => setSelectedElement(el)} 
                            isMobile={isMobile}
                            elementDataOverride={elementData}
                        />
                    </div>

                    <DetailModal 
                        element={selectedElement} 
                        onClose={() => setSelectedElement(null)} 
                    />
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = createRoot(rootElement);
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>
</html>
